---
title: "JAMES version maintaince"
author: "Stef van Buuren"
format: html
---

```{r setup}
#| include: false
#| cache: false
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Objective

- This document contains the steps to create a new JAMES version. 
- You can also `Render` this document to check and update the JAMES version in the package and documentation files.

## Local JAMES development

### Update and lock packages


- Use the function `james::install_dev_packages()` to install the development packages (like roxygen2) when starting fresh
- If needed, clean out the development packages by `renv::clean(prompt = TRUE)` from the library before using `renv::snapshot()` to update the lock file.


Are all R packages up to data and complete?

```{r}
renv::status()
```

If packages need updated, use `renv::restore()`.

### Open, work and close issues in GitHub

-   Solve relevant issues in `james` package
-   <https://github.com/growthcharts/james/issues>
-   Do relevant updates in underlying packages and install update `renv::install()`. Use github URL for github packages. Now project is out-of-sync, this is OK.
-   Update functions in `james` package that use these underlying functions
    -  (1) update james function
    -  (2) update documention `devtools::document()`

### Update `openapi.yaml`

The source text of the OpenAPI specification is in `inst/spec/openapi.in.yaml`. Before building the package, this file needs updating with the current JAMES version from the `DESCRIPTION` file. This ensures that the two remain in sync.

To add an argument to dcat, search for dcat_arguments and add the argument that was added to the function. 


### Check the top level package `james`

```{r}
# devtools::check()
```

### Update the package version

-   Update `NEWS.md` with version update and document changes.
-   Increase version number in DESCRIPTION file
-   Also update imports version with proper versions for updated packages.

```{r}
# devtools::check()
```

### Keep `renv.lock` in shape

- Check `renv::status` and commit changes to `renv.lock`. 
- Only include packages that are relevant to the JAMES package, not the development packages in the project

Use "explicit" mode to evade helpers like `devtools` and `roxygen2` in the lock file. 
```{r}
renv::snapshot(type = "explicit")
```


### Update version in HTML and Rmd files

If you change DESCRIPTION version number, update two files with new version numbers:
  - the HTML demo app at index.html
  - the `_getting_started.qmd` vignette

```{r eval= FALSE}
james:::update_version_files(
  "inst/www/index.html",
  "vignettes/articles/_getting_started.qmd",
  "DESCRIPTION"
)
```

Update version number van `openapi.in.yaml` file

```{r eval=FALSE}
james:::update_openapi_spec()
```


### Update documentation

- Build documentation using a combination of ``pkgdown::built_site()` and `quarto::quarto_render()`
-   `quarto_render()` builds the getting started vignette 
-    `bash` code does not work Windows, and will be skipped by setting `eval=FALSE` under Windows
-   By default, the script runs server `target_host = "test"` (james.groeidiagrammen.nl)
-   Note: The `getting_started.qmd` is also runs within the container, so check any changes also in that environment in the `jamesdocker` package
- Run the following chunk to update site

```{r}
quarto::quarto_render(
  input = 'vignettes/articles/_getting_started.qmd',
  quarto_args = c('--output-dir', file.path(getwd(), 'docs/articles'))
)
file.rename(
  'docs/articles/_getting_started.html',
  'docs/articles/getting_started.html'
)
file.rename(
  'docs/articles/_getting_started_files',
  'docs/articles/getting_started_files'
)
html <- readLines('docs/articles/getting_started.html')
html <- gsub(
  '_getting_started_files/',
  'getting_started_files/',
  html,
  fixed = TRUE
)
writeLines(html, 'docs/articles/getting_started.html')
pkgdown::build_site()
```

## Push and go

-   Push changes to GitHub in following separate commits
    - (1) function changes
    - (2) update package version, NEWS and lock file
    - (3) update site docs
-   Go to `jamesdocker` repo for building app
